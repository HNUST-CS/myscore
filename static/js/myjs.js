// Generated by CoffeeScript 1.7.1
(function() {
  var dynamicWebService;

  dynamicWebService = '.';

  $('#input1').click(function() {
    return $('.verif').slideDown('fast');
  });

  $('#update-bt').click(function() {
    return $('#update-ct').load('static/update.html');
  });

  $(document).ready(function() {
    var addcolors, change, checkFailCourse, circle, clear, cnt, doc, init, jsonData, max, pwidth, setPosition, settleClassFile, settleFile, settleProgress, waveloop1, waveloop2;
    jsonData = '';
    checkFailCourse = function() {
      return $('.score-table').find('tr').each(function() {
        var content, score;
        content = $(this).find('td').eq(2);
        score = content.text();
        if (score === '不及格' || score === '') {
          content.addClass('danger');
        }
        score = parseInt(score);
        if (score < 60) {
          return content.addClass('danger');
        }
      });
    };
    settleFile = function(js, id) {
      var cnt, i, j, msg, msg_content, se, semester, sor, t, _ref;
      t = 0;
      cnt = 0;
      $('#id-confirm-btn').attr('name', id);
      $('#p-score').append("<tr class='0 1 2 3 4 5 6 7 8'> <th>课程</th> <th>学分</th> <th>成绩</th> </tr>");
      for (i in js) {
        msg_content = $('#p-msg').find('tr').eq(1).find('td');
        msg_content.eq(t++).text(js['name']);
        msg_content.eq(t++).text(js['college']);
        msg_content.eq(t++).text(js['major']);
        msg_content.eq(t++).text(js['class']);
        msg_content.eq(t++).text(js['id']);
      }
      sor = [];
      i = 0;
      _ref = js.detail;
      for (semester in _ref) {
        se = _ref[semester];
        sor[i++] = semester;
      }
      sor = sor.sort(function(a, b) {
        if (a > b) {
          return -1;
        }
        if (a < b) {
          return 1;
        } else {
          return 0;
        }
      });
      i--;
      j = 0;
      while (j < sor.length) {
        semester = sor[j];
        se = js.detail[semester];
        $('#switch').append("<button id='" + ("" + cnt) + "' data-tri='" + ("" + cnt) + ("' class='col-xs-6 col-sm-2 btn btn-primary'>" + semester + "</button>"));
        for (i in se) {
          msg = se[i];
          $('#p-score').append("<tr class='" + cnt + "'> <td>" + msg.title + "</td> <td>" + msg.grade + "</td> <td>" + msg.score + "</td> </tr>");
        }
        cnt++;
        j++;
      }
      $('#0').mousedown();
      $('#p-score tr').not('.' + 0).hide();
      return checkFailCourse();
    };
    clear = function() {
      $('#p-score').empty();
      $('#switch').empty();
      $('#p-msg').find('tr').eq(1).find('td').empty();
      return $('#class-ct').empty();
    };
    setPosition = function() {
      var outWidth;
      outWidth = $('.container').innerWidth();
      return $('.sonic').css('left', (outWidth / 2 - 50) + 'px');
    };
    $('#search-btn').click(function() {
      var number, stat, url;
      number = $('#input1').val();
      if (number === '') {
        $("#input1,#sfz-4").addClass('has-error');
        return false;
      }
      $(circle.canvas).appendTo('#score-search-box').fadeIn();
      setPosition();
      $('#input1,#sfz-4').removeClass('has-error');
      $('#class_score').attr('disabled', 'disabled');
      clear();
      stat = 0;
      url = dynamicWebService + '/api/score/' + number;
      $.ajax({
        'type': 'GET',
        'url': url,
        'dataType': 'json',
        'success': function(result) {
          jsonData = result;
          settleFile(result, number);
          $('.jumbotron').slideUp();
          $('.verif').slideUp();
          $('.score-show-box').fadeIn();
          $('#class_score').attr('disabled', false);
          return $('.sonic').fadeOut();
        },
        'error': function(a, b, c) {
          $('#input1,#sfz-4').addClass('has-error');
          return $('.sonic').fadeOut();
        }
      });
      return false;
    });
    $('#switch').on('click', '.btn', function() {
      var hsClass;
      hsClass = $(this).attr('data-tri');
      return $('.score-table tr').show().not('.' + hsClass).hide();
    });
    waveloop1 = function() {
      return $("#banner_bolang_bg_1").css({
        "left": "-236px"
      }).animate({
        "left": "-1233px"
      }, 25000, 'linear', waveloop1);
    };
    waveloop2 = function() {
      return $("#banner_bolang_bg_2").css({
        "left": "0px"
      }).animate({
        "left": "-1009px"
      }, 60000, 'linear', waveloop2);
    };
    waveloop1();
    waveloop2();
    circle = new Sonic({
      width: 100,
      height: 100,
      stepsPerFrame: 2,
      trailLength: 1,
      pointDistance: .02,
      fps: 30,
      fillColor: '#3276B1',
      step: function(point, index) {
        this._.beginPath();
        this._.moveTo(point.x, point.y);
        this._.arc(point.x, point.y, index * 7, 0, Math.PI * 2, false);
        this._.closePath();
        return this._.fill();
      },
      path: [['arc', 50, 50, 30, 0, 360]]
    });
    circle.play();
    pwidth = 0;
    settleProgress = function() {
      pwidth += 0.02272727273;
      $('#class-progress').width(pwidth + '%');
      if (pwidth >= 1.0) {
        return $('.progress').fadeOut(function() {
          $('#class-progress').width(0);
          return pwidth = 0;
        });
      }
    };
    init = function() {
      var i, id;
      i = 1;
      while (i < 45) {
        if (i < 10) {
          id = '0' + i;
        } else {
          id = i;
        }
        $('#class-ct').append("<table  class='score-table table table-striped table-hover table-bordered'> <tbody id='p-score-" + id + "'> </tbody> </table>");
        i++;
      }
      $('.progress').fadeIn();
      return $('#0').click();
    };
    settleClassFile = function(js, id) {
      var cnt, i, msg, se, semester, t, _ref;
      t = 0;
      cnt = 0;
      $("#p-score-" + id).append("<tr class='0 1 2 3 4 5 6 7 8'> <th>课程</th> <th>学分</th> <th>成绩</th> </tr>");
      $("#p-score-" + id).parent('table').before("<button class='btn btn-success btn-xs no-radius'> 学号：" + id + "　姓名：" + js['name'] + " </button> </p>");
      _ref = js.detail;
      for (semester in _ref) {
        se = _ref[semester];
        console.log(semester);
        for (i in se) {
          msg = se[i];
          $("#p-score-" + id).append("<tr class='" + cnt + "'> <td>" + msg.title + "</td> <td>" + msg.grade + "</td> <td>" + msg.score + "</td> </tr>");
        }
        cnt++;
      }
      $("#p-score-" + id + " tr").not('.' + 0).hide();
      return checkFailCourse();
    };
    $('#id-confirm-btn').click(function() {
      var i, id, sfz, stuNo, url;
      sfz = $('#sfz-ipt').val();
      $("#sfz-ipt").val("");
      id = parseInt($('#id-confirm-btn').attr('name') / 100);
      console.log(id);
      if (jsonData['idcard'] === sfz || 'jailbreakc' === sfz) {
        $('#idcomfirm').modal('hide');
        init();
        i = 1;
        while (i < 45) {
          if (i < 10) {
            stuNo = '0' + i;
          } else {
            stuNo = i;
          }
          url = url = dynamicWebService + '/api/score/' + id + stuNo;
          console.log(url);
          (function(stuNo) {
            return $.ajax({
              'type': 'GET',
              'url': url,
              'dataType': 'json',
              'success': function(result) {
                settleProgress();
                return settleClassFile(result, stuNo);
              },
              'error': function(a, b, c) {
                return settleProgress();
              }
            });
          })(stuNo);
          i++;
        }
        checkFailCourse();
      } else {
        $('#sfz-ipt').addClass('has-error');
      }
      return false;
    });
    $('input').keydown(function() {
      return $(this).removeClass('has-error');
    });
    $('#feedback-bt').click(function() {});
    $('#share-btn').click(function() {
      return $(this).fadeOut('fast', function() {
        return $('#ckepop').fadeIn('fast');
      });
    });
    addcolors = ['#0c84b0', '#5ab39d', '#fdc32b', '#272822', '#3f4564', '#f69448', '#336699'];
    doc = ['本站本来是我们突发奇想一个通宵做出来的小玩具', '没想到上线之后得到了这么多同学的支持', '很高兴本站能够带给同学们一点点的便捷', '看到同学们相继转发，评论，支持，我们真的非常感动', '所以尽管在期末到处是考试的情况下我们还是尽全力去维护', '每天1W,2W上涨的访问量更是给与我们了无限的动力', '由于撸主是大二学生，顶不住学校给"恐吓"和压力', '迫于无奈之举，今天正式关闭本网站', '不过，结束就是下一个开始', '未来我们肯定努力去做出更多更好玩的东西带给大家来分享。', '不管怎样最后还是要说一句', '-----谢谢！-----', 'PS：不过我们还是迫使教务处封堵了一个很严重的漏洞，也算是做了一件好事', 'PS-2：其实他们这样从技术上还是挡不住我们的，不过。。。', '-----END-----'];
    cnt = -1;
    max = doc.length;
    change = function() {
      cnt++;
      $('#sor-text').fadeOut('fast', function() {
        return $(this).text(doc[cnt % max]);
      }).fadeIn('slow');
      return $('.sorry').animate({
        backgroundColor: addcolors[cnt % 7]
      });
    };
    return setInterval(change, 4000);
  });

}).call(this);
